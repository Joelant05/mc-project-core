(function(o,h){typeof exports=="object"&&typeof module!="undefined"?h(exports,require("path-browserify"),require("json5"),require("bridge-common-utils")):typeof define=="function"&&define.amd?define(["exports","path-browserify","json5","bridge-common-utils"],h):(o=typeof globalThis!="undefined"?globalThis:o||self,h(o.MCProjectCore={},o.pathBrowserify,o.json5,o.bridgeCommonUtils))})(this,function(o,h,C,b){"use strict";function F(u){return u&&typeof u=="object"&&"default"in u?u:{default:u}}var x=F(C);const d={behaviorPack:"./BP",resourcePack:"./RP",skinPack:"./SP",worldTemplate:"./WT"};class w{constructor(e){this.basePath=e,this.data={}}async refreshConfig(){this.data=await this.readConfig()}async setup(){await this.refreshConfig()}get(){return this.data}getPackRoot(e){var t,s;return(s=(t=this.data.packs)==null?void 0:t[e])!=null?s:d[e]}resolvePackPath(e,t){return!t&&!e?this.basePath:!e&&t?h.join(this.basePath,t):!t&&e?h.resolve(this.basePath,this.getPackRoot(e)):h.resolve(this.basePath,`${this.getPackRoot(e)}/${t}`)}getAvailablePackPaths(){var t;const e=[];for(const s of Object.keys((t=this.data.packs)!=null?t:{}))e.push(this.resolvePackPath(s));return e}getAvailablePacks(){var t;const e={};for(const s in(t=this.data.packs)!=null?t:{})e[s]=this.resolvePackPath(s);return e}async save(){await this.writeConfig(this.data)}}class A{constructor(e){this.projectConfig=e,this.packTypes=[],this.extensionPackTypes=new Set}setProjectConfig(e){this.projectConfig=e}get all(){return this.packTypes.concat(...Array.from(this.extensionPackTypes.values()))}getFromId(e){return this.all.find(t=>t.id===e)}get(e){var s,n;const t=(n=(s=this.projectConfig)==null?void 0:s.getAvailablePacks())!=null?n:d;for(const a in t)if(e.startsWith(t[a]))return this.getFromId(a)}getId(e){var t,s;return(s=(t=this.get(e))==null?void 0:t.id)!=null?s:"unknown"}addExtensionPackType(e){return this.extensionPackTypes.add(e),{dispose:()=>this.extensionPackTypes.delete(e)}}}class M{constructor(e,t){this.projectConfig=e,this.isMatch=t,this.pluginFileTypes=new Set,this.fileTypes=[]}get all(){return this.fileTypes.concat([...this.pluginFileTypes.values()])}setProjectConfig(e){this.projectConfig=e}addPluginFileType(e){return this.pluginFileTypes.add(e),{dispose:()=>this.pluginFileTypes.delete(e)}}getPluginFileTypes(){return[...this.pluginFileTypes.values()]}setPluginFileTypes(e=[]){this.pluginFileTypes.clear(),e.forEach(t=>this.pluginFileTypes.add(t))}get(e,t){var n,a,l,r,c,p,f,g,y,P,k,T,j;const s=e?h.extname(e):null;for(const i of this.all){if(t!==void 0&&t===i.id)return i;if(!e)continue;const m=((n=i.detect)==null?void 0:n.packType)===void 0?[]:Array.isArray((a=i.detect)==null?void 0:a.packType)?(l=i.detect)==null?void 0:l.packType:[(r=i.detect)==null?void 0:r.packType],v=(c=i.detect)==null?void 0:c.fileExtensions,S=!!((p=i.detect)==null?void 0:p.scope),E=Array.isArray((f=i.detect)==null?void 0:f.scope)?(g=i.detect)==null?void 0:g.scope:[(y=i.detect)==null?void 0:y.scope],W=!!((P=i.detect)==null?void 0:P.matcher),_=Array.isArray((k=i.detect)==null?void 0:k.matcher)?(T=i.detect)==null?void 0:T.matcher:[(j=i.detect)==null?void 0:j.matcher];if(!(v&&s&&!v.includes(s)))if(S){if(this.prefixMatchers(m,E).some(I=>e.startsWith(I)))return i}else if(W){if(this.isMatch(e,this.prefixMatchers(m,_)))return i}else throw console.log(i),new Error('Invalid file definition, no "detect" properties')}}prefixMatchers(e,t){if(!this.projectConfig)return[];if(e.length===0)return t.map(n=>this.projectConfig.resolvePackPath(void 0,n));const s=[];for(const n of e)for(const a of t)s.push(this.projectConfig.resolvePackPath(n,a));return s}getIds(){const e=[];for(const t of this.all)e.push(t.id);return e}async guessFolder(e){var l;const t=r=>{let c=Array.isArray(r)?r[0]:r;return c.endsWith("/")||(c+="/"),c},s=`.${e.name.split(".").pop()}`;for(const{detect:r={}}of this.all)if(!!r.scope&&((l=r.fileExtensions)==null?void 0:l.includes(s)))return t(r.scope);if(!e.name.endsWith(".json"))return null;const n=await e.getFile();let a;try{a=x.default.parse(await n.text())}catch{return null}for(const{type:r,detect:c}of this.all){if(typeof r=="string"&&r!=="json")continue;const{scope:p,fileContent:f}=c!=null?c:{};if(!(!p||!f)&&!!b.hasAnyPath(a,f))return t(p)}return null}getId(e){var t,s;return(s=(t=this.get(e))==null?void 0:t.id)!=null?s:"unknown"}isJsonFile(e){var s,n;const t=(n=(s=this.get(e))==null?void 0:s.meta)==null?void 0:n.language;return t?t==="json":e.endsWith(".json")}}o.FileType=M,o.PackType=A,o.ProjectConfig=w,o.defaultPackPaths=d,Object.defineProperty(o,"__esModule",{value:!0}),o[Symbol.toStringTag]="Module"});
